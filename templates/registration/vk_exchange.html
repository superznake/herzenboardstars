{% extends "base.html" %}

{% block content %}
<script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
<script type="text/javascript">
  // Обмениваем код на токен на клиенте
  if ('VKIDSDK' in window) {
    const VKID = window.VKIDSDK;
    const code = '{{ code }}';
    const deviceId = '{{ device_id }}';

    VKID.Auth.exchangeCode(code, deviceId)
      .then(function(tokenData) {
        // После успешного обмена отправляем токен на сервер
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/oauth/complete/vk-oauth2/';

        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = 'access_token';
        tokenInput.value = tokenData.token || tokenData.access_token;
        form.appendChild(tokenInput);

        const userIdInput = document.createElement('input');
        userIdInput.type = 'hidden';
        userIdInput.name = 'user_id';
        userIdInput.value = tokenData.user_id;
        form.appendChild(userIdInput);

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
      })
      .catch(function(error) {
        console.error('VKID exchange error:', error);
        alert('Ошибка авторизации: ' + (error?.text || error?.message || 'неизвестная ошибка'));
        window.location.href = '/auth/login/';
      });
  } else {
    console.error('VKID SDK не загружен');
    alert('Ошибка загрузки VK ID SDK');
    window.location.href = '/auth/login/';
  }
</script>
<p>Обработка авторизации...</p>
{% endblock %}

