{% extends "base.html" %}

{% block content %}
<div style="text-align: center; padding: 50px 20px;">
    <h2>Обработка авторизации...</h2>
    <p id="status-message">Инициализация VK ID SDK...</p>
    <div id="error-message" style="display: none; color: red; margin-top: 20px; padding: 15px; background: #ffe6e6; border-radius: 5px;"></div>
</div>
<script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
<script type="text/javascript">
  console.log('VK Exchange page loaded');

  function updateStatus(message) {
    const el = document.getElementById('status-message');
    if (el) el.textContent = message;
    console.log(message);
  }

  function showError(message) {
    const el = document.getElementById('error-message');
    if (el) {
      el.textContent = message;
      el.style.display = 'block';
    }
    console.error(message);
  }

  function performExchange() {
    if (!('VKIDSDK' in window)) {
      updateStatus('VKID SDK не загружен, ожидание...');
      setTimeout(performExchange, 150);
      return;
    }

    updateStatus('VKID SDK загружен, инициализация...');

    const VKID = window.VKIDSDK;

    try {
      VKID.Config.init({
        app: {{ VK_APP_ID|default:"54356598" }},
        redirectUrl: '{{ VK_REDIRECT_URI|default:"https://herzenboardstars.lol/oauth/complete/vk-oauth2/" }}',
        responseMode: VKID.ConfigResponseMode.Callback,
        source: VKID.ConfigSource.LOWCODE,
        scope: '',
      });
      updateStatus('Конфигурация SDK инициализирована');
    } catch (e) {
      showError('Ошибка инициализации SDK: ' + e.message);
      console.error('Config init failed:', e);
      setTimeout(() => window.location.href = '/auth/login/', 3000);
      return;
    }

    const code = '{{ code }}';
    const deviceId = '{{ device_id }}';

    if (!code || !deviceId) {
      showError('Отсутствует код авторизации или device_id');
      setTimeout(() => window.location.href = '/auth/login/', 3000);
      return;
    }

    updateStatus('Обмен кода на токен...');
    console.log('Exchange start:', code.substring(0, 20) + '...', 'deviceId:', deviceId);

    VKID.Auth.exchangeCode(code, deviceId)
      .then((tokenData) => {
        console.log('Exchange success:', tokenData);

        // VK ID SDK уже умеет возвращать данные пользователя, иногда они лежат в tokenData.user
        let user = tokenData.user || null;

        if (!user) {
          // fallback если структура другая
          const data = tokenData.data || tokenData.response || tokenData;
          user = data?.user || data?.profile || null;
        }

        if (!user) {
          showError('Ошибка: данные пользователя не получены. Ответ: ' + JSON.stringify(tokenData));
          console.error('User object missing:', tokenData);
          setTimeout(() => window.location.href = '/auth/login/', 5000);
          return;
        }

        const userId = user.id || user.user_id || user.uid;
        const firstName = user.first_name || user.firstName || '';
        const lastName = user.last_name || user.lastName || '';

        if (!userId) {
          showError('Ошибка: нет user_id в ответе.');
          setTimeout(() => window.location.href = '/auth/login/', 5000);
          return;
        }

        updateStatus('Авторизация завершена, отправка данных на сервер...');

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/oauth/complete/vk-oauth2/';

        function addField(name, value) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = name;
          input.value = value;
          form.appendChild(input);
        }

        addField('user_id', userId);
        addField('first_name', firstName);
        addField('last_name', lastName);

        addField('csrfmiddlewaretoken', '{{ csrf_token }}');

        document.body.appendChild(form);
        console.log('Submitting form with:', { userId, firstName, lastName });
        form.submit();
      })
      .catch((error) => {
        const msg = 'Ошибка обмена кода: ' + (error?.text || error?.message || 'неизвестная ошибка');
        showError(msg);
        console.error('exchangeCode error:', error);
        setTimeout(() => window.location.href = '/auth/login/', 5000);
      });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => setTimeout(performExchange, 400));
  } else {
    setTimeout(performExchange, 400);
  }
</script>
{% endblock %}