{% extends "base.html" %}

{% block content %}
<p>Обработка авторизации...</p>
<script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
<script type="text/javascript">
  console.log('VK Exchange page loaded');
  
  // Инициализируем SDK перед использованием
  function performExchange() {
    if (!('VKIDSDK' in window)) {
      console.log('VKID SDK не загружен, ожидание...');
      setTimeout(performExchange, 100);
      return;
    }

    const VKID = window.VKIDSDK;
    
    // Инициализируем конфигурацию SDK (важно для работы exchangeCode)
    try {
      VKID.Config.init({
        app: {{ VK_APP_ID|default:"54356598" }},
        redirectUrl: '{{ VK_REDIRECT_URI|default:"https://herzenboardstars.lol/oauth/complete/vk-oauth2/" }}',
        responseMode: VKID.ConfigResponseMode.Callback,
        source: VKID.ConfigSource.LOWCODE,
        scope: '',
      });
      console.log('VKID SDK initialized');
    } catch (e) {
      console.error('Failed to init VKID Config:', e);
    }

    const code = '{{ code }}';
    const deviceId = '{{ device_id }}';

    console.log('Starting code exchange, code:', code.substring(0, 20) + '...', 'deviceId:', deviceId);

    // Используем SDK для обмена кода
    VKID.Auth.exchangeCode(code, deviceId)
      .then(function(tokenData) {
        console.log('Exchange successful, tokenData keys:', Object.keys(tokenData));
        
        // Проверяем структуру ответа - VK ID SDK может возвращать разные форматы
        let accessToken = null;
        let userId = null;

        // Пробуем разные возможные поля
        if (tokenData.token) {
          accessToken = tokenData.token;
          userId = tokenData.user_id || tokenData.userId || tokenData.uid;
        } else if (tokenData.access_token) {
          accessToken = tokenData.access_token;
          userId = tokenData.user_id || tokenData.userId || tokenData.uid;
        } else if (tokenData.accessToken) {
          accessToken = tokenData.accessToken;
          userId = tokenData.userId || tokenData.user_id || tokenData.uid;
        } else {
          // Может быть вложенная структура
          const data = tokenData.data || tokenData.response || tokenData;
          accessToken = data?.token || data?.access_token || data?.accessToken;
          userId = data?.user_id || data?.userId || data?.uid;
        }

        console.log('Extracted token:', accessToken ? 'present' : 'missing', 'user_id:', userId);

        if (!accessToken || !userId) {
          console.error('Missing token or user_id. Full response:', tokenData);
          alert('Ошибка: не удалось получить токен от VK. Проверьте консоль для деталей.');
          setTimeout(function() {
            window.location.href = '/auth/login/';
          }, 3000);
          return;
        }

        // Получаем информацию о пользователе на клиенте (чтобы избежать проблем с IP)
        console.log('Fetching user info from VK API...');
        const vkApiUrl = 'https://api.vk.com/method/users.get';
        const vkParams = new URLSearchParams({
          user_ids: userId,
          access_token: accessToken,
          fields: 'first_name,last_name',
          v: '5.131'
        });

        fetch(vkApiUrl + '?' + vkParams.toString())
          .then(function(response) {
            return response.json();
          })
          .then(function(vkData) {
            console.log('VK API response:', vkData);
            
            if (vkData.error) {
              console.error('VK API error:', vkData.error);
              alert('Ошибка при получении данных пользователя: ' + (vkData.error.error_msg || 'Неизвестная ошибка'));
              setTimeout(function() {
                window.location.href = '/auth/login/';
              }, 3000);
              return;
            }

            if (!vkData.response || !vkData.response[0]) {
              console.error('No user data in VK response');
              alert('Не удалось получить данные пользователя из VK.');
              setTimeout(function() {
                window.location.href = '/auth/login/';
              }, 3000);
              return;
            }

            const vkUser = vkData.response[0];
            const firstName = vkUser.first_name || '';
            const lastName = vkUser.last_name || '';

            console.log('User info retrieved:', firstName, lastName);

            // Отправляем данные пользователя на сервер (без access_token)
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/oauth/complete/vk-oauth2/';

            const userIdInput = document.createElement('input');
            userIdInput.type = 'hidden';
            userIdInput.name = 'user_id';
            userIdInput.value = userId;
            form.appendChild(userIdInput);

            const firstNameInput = document.createElement('input');
            firstNameInput.type = 'hidden';
            firstNameInput.name = 'first_name';
            firstNameInput.value = firstName;
            form.appendChild(firstNameInput);

            const lastNameInput = document.createElement('input');
            lastNameInput.type = 'hidden';
            lastNameInput.name = 'last_name';
            lastNameInput.value = lastName;
            form.appendChild(lastNameInput);

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            console.log('Submitting form to server with user data');
            form.submit();
          })
          .catch(function(error) {
            console.error('Error fetching user info:', error);
            alert('Ошибка соединения с VK: ' + error.message);
            setTimeout(function() {
              window.location.href = '/auth/login/';
            }, 3000);
          });
      })
      .catch(function(error) {
        console.error('VKID exchange error:', error);
        const errorMsg = error?.text || error?.message || error?.error_description || 'неизвестная ошибка';
        console.error('Error details:', errorMsg, 'Full error:', error);
        alert('Ошибка авторизации: ' + errorMsg + '\n\nПроверьте консоль браузера для деталей.');
        setTimeout(function() {
          window.location.href = '/auth/login/';
        }, 3000);
      });
  }

  // Запускаем обмен после загрузки SDK
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(performExchange, 500); // Даём время SDK загрузиться
    });
  } else {
    setTimeout(performExchange, 500);
  }
</script>
{% endblock %}

