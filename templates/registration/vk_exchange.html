{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <h3 class="mt-3">Выполняется вход через VK...</h3>
            <p class="text-muted" id="status-text">Пожалуйста, подождите</p>
        </div>
    </div>
</div>

<!-- Load VK ID SDK with error handling -->
<script src="https://unpkg.com/@vkid/sdk@2.2.0/dist-sdk/umd/index.js" id="vkid-script"></script>

<script>
// Configuration
const VK_APP_ID = {{ VK_APP_ID|default:54356598 }};
const VK_REDIRECT_URI = window.location.origin + "{{ request.path }}";

// Function to update status message
function updateStatus(message, isError = false) {
    const statusText = document.getElementById('status-text');
    if (statusText) {
        statusText.textContent = message;
        if (isError) {
            statusText.classList.add('text-danger');
        }
    }
}

// Function to handle VK SDK load errors
function handleSDKLoadError() {
    const spinner = document.querySelector('.spinner-border');
    if (spinner) {
        spinner.classList.remove('spinner-border', 'text-primary');
        spinner.classList.add('text-danger');
    }
    updateStatus('Не удалось загрузить VK ID SDK. Пожалуйста, обновите страницу или попробуйте позже', true);
    console.error('VK ID SDK failed to load');
}

// Function to initialize VK ID
function initVKID() {
    if (typeof VKID === 'undefined') {
        handleSDKLoadError();
        return false;
    }

    try {
        VKID.Config.set({
            app: VK_APP_ID,
            redirectUrl: VK_REDIRECT_URI,
            scopes: ["openid", "email"]
        });
        return true;
    } catch (e) {
        console.error('VK ID initialization error:', e);
        updateStatus('Ошибка инициализации VK ID', true);
        return false;
    }
}

// Function to handle VK authentication
async function handleVKAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');

    if (!code) {
        updateStatus('Отсутствует код авторизации VK', true);
        return;
    }

    try {
        updateStatus('Обмен кода авторизации...');
        const exchangeResult = await VKID.Auth.exchangeCode(code, state);
        
        if (!exchangeResult?.access_token) {
            throw new Error('Не удалось получить токен доступа');
        }

        updateStatus('Получение данных пользователя...');
        const userInfo = await fetch("https://id.vk.com/oauth2/user_info", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${exchangeResult.access_token}`
            }
        }).then(r => r.json());

        if (!userInfo?.sub) {
            console.error("VK userinfo response:", userInfo);
            throw new Error('Не удалось получить данные пользователя');
        }

        updateStatus('Вход в систему...');
        const response = await fetch("{{ request.path }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                vk_id: userInfo.sub,
                first_name: userInfo.given_name || "",
                last_name: userInfo.family_name || "",
                email: userInfo.email || "",
                access_token: exchangeResult.access_token
            })
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || 'Ошибка сервера');
        }

        const result = await response.json();
        window.location.href = result.redirect || "/";

    } catch (error) {
        console.error('VK Auth Error:', error);
        updateStatus(error.message || 'Произошла ошибка при авторизации', true);
        
        // Add retry button
        const container = document.querySelector('.container');
        if (container) {
            const retryBtn = document.createElement('button');
            retryBtn.className = 'btn btn-primary mt-3';
            retryBtn.textContent = 'Повторить';
            retryBtn.onclick = () => window.location.reload();
            container.appendChild(retryBtn);
        }
    }
}

// Initialize when SDK is loaded
function onSDKLoad() {
    if (initVKID()) {
        handleVKAuth();
    }
}

// Check if SDK is already loaded
if (window.VKID) {
    onSDKLoad();
} else {
    // Fallback if script.onload doesn't fire
    setTimeout(() => {
        if (window.VKID) {
            onSDKLoad();
        } else {
            handleSDKLoadError();
        }
    }, 2000);
}

// Add event listener for script load
document.getElementById('vkid-script').addEventListener('load', onSDKLoad);
document.getElementById('vkid-script').addEventListener('error', handleSDKLoadError);
</script>

<style>
.spinner-border {
    width: 3rem;
    height: 3rem;
}
</style>
{% endblock %}