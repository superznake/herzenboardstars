{% extends "base.html" %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход через VK</title>
    <script src="https://unpkg.com/@vkid/sdk@2.2.0/dist-sdk/umd/index.js"></script>
</head>

<body style="font-family: sans-serif; padding: 20px;">
<script>
(async () => {
    // Идентификатор приложения VK ID
    const APP_ID = 543565598;

    // Настройки SDK
    VKID.Config.set({
        app: APP_ID,
        redirectUrl: window.location.origin + "/oauth/complete/vk-oauth2/",
        scopes: ["openid", "email", "phone"]
    });

    // Ищем code в URL — VK его передал после редиректа
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");

    if (!code) {
        document.body.innerHTML = "<h2>Ошибка: отсутствует код VK</h2>";
        return;
    }

    try {
        // 1️⃣ Обмениваем code на токены
        const exchangeResult = await VKID.Auth.exchangeCode(code);

        if (!exchangeResult || !exchangeResult.access_token) {
            throw new Error("Токены не получены");
        }

        const accessToken = exchangeResult.access_token;

        // 2️⃣ Получаем данные пользователя ОФИЦИАЛЬНЫМ способом OIDC
        const userInfo = await fetch("https://id.vk.com/oauth2/user_info", {
            method: "GET",
            headers: {
                "Authorization": "Bearer " + accessToken
            }
        }).then(r => r.json());

        if (!userInfo || !userInfo.sub) {
            console.error("VK userinfo response:", userInfo);
            document.body.innerHTML = "<h2>Ошибка: данные пользователя не получены</h2>";
            return;
        }

        // 3️⃣ Передаём данные пользователя в Django
        const backendResponse = await fetch(window.location.pathname, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                vk_id: userInfo.sub,
                first_name: userInfo.given_name || "",
                last_name: userInfo.family_name || "",
                email: userInfo.email || "",
                access_token: accessToken,
                refresh_token: exchangeResult.refresh_token || null,
                id_token: exchangeResult.id_token || null
            })
        }).then(r => r.json());

        // 4️⃣ Проверяем успех
        if (backendResponse.success) {
            window.location.href = backendResponse.redirect || "/";
        } else {
            console.error("Server error:", backendResponse);
            document.body.innerHTML =
                "<h2>Ошибка на стороне сервера</h2><pre>" + JSON.stringify(backendResponse, null, 2) + "</pre>";
        }

    } catch (e) {
        console.error("VK Auth Exception:", e);
        document.body.innerHTML = `<h2>Ошибка авторизации VK</h2><pre>${e}</pre>`;
    }
})();
</script>

<h3>Выполняется вход через VK...</h3>

</body>
{% endblock %}