{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <h3 class="mt-3">Выполняется вход через VK...</h3>
            <p class="text-muted" id="status-text">Инициализация VK ID...</p>
            <div id="debug-info" class="text-start small text-muted mt-3" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- Load VK ID SDK directly from VK's CDN -->
<script src="https://id.vk.com/js/api/openapi.js" type="text/javascript" id="vkid-script"></script>

<script>
// Debug function to log messages
function debugLog(message) {
    console.log('[DEBUG]', message);
    const debugEl = document.getElementById('debug-info');
    if (debugEl) {
        debugEl.style.display = 'block';
        debugEl.innerHTML += `<div>${new Date().toISOString()}: ${message}</div>`;
    }
}

// Function to update status message
function updateStatus(message, isError = false) {
    debugLog(`Status update: ${message}`);
    const statusText = document.getElementById('status-text');
    if (statusText) {
        statusText.textContent = message;
        if (isError) {
            statusText.classList.add('text-danger');
        }
    }
}

// Function to show error message
function showError(message) {
    debugLog(`Error: ${message}`);
    updateStatus(message, true);
    const container = document.querySelector('.container');
    if (container) {
        const retryBtn = document.createElement('button');
        retryBtn.className = 'btn btn-primary mt-3';
        retryBtn.textContent = 'Повторить';
        retryBtn.onclick = () => window.location.reload();
        container.appendChild(retryBtn);
    }
}

// Main authentication function
async function handleVKAuth() {
    try {
        updateStatus('Проверка загрузки VK ID SDK...');
        
        // Check if VK object is available
        if (typeof VK === 'undefined') {
            throw new Error('VK SDK не загружен. Пожалуйста, проверьте подключение к интернету.');
        }

        updateStatus('Инициализация VK API...');
        
        // Initialize VK API
        VK.init({
            apiId: {{ VK_APP_ID|default:54356598 }},
            onlyWidgets: false
        });

        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (!code) {
            throw new Error('Отсутствует код авторизации VK');
        }

        updateStatus('Обмен кода авторизации...');
        
        // Exchange code for access token
        const response = await fetch("{{ request.path }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                code: code,
                redirect_uri: window.location.origin + "{{ request.path }}"
            })
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || 'Ошибка сервера при обмене кода');
        }

        const result = await response.json();
        debugLog('Auth result:', result);
        
        if (result.redirect) {
            window.location.href = result.redirect;
        } else {
            window.location.href = "/";
        }

    } catch (error) {
        console.error('VK Auth Error:', error);
        showError(error.message || 'Произошла ошибка при авторизации');
    }
}

// Wait for the page and VK SDK to load
document.addEventListener('DOMContentLoaded', () => {
    // Start checking for VK SDK
    let attempts = 0;
    const maxAttempts = 10;
    const checkInterval = 500; // ms

    const checkVKSDK = setInterval(() => {
        attempts++;
        debugLog(`Проверка VK SDK (попытка ${attempts}/${maxAttempts})`);
        
        if (window.VK) {
            clearInterval(checkVKSDK);
            debugLog('VK SDK загружен, начинаем аутентификацию');
            handleVKAuth();
        } else if (attempts >= maxAttempts) {
            clearInterval(checkVKSDK);
            showError('Не удалось загрузить VK SDK. Пожалуйста, проверьте подключение к интернету и обновите страницу.');
        }
    }, checkInterval);

    // Also try to handle script load/error events
    const vkScript = document.getElementById('vkid-script');
    if (vkScript) {
        vkScript.addEventListener('load', () => {
            debugLog('Скрипт VK загружен');
            if (window.VK) {
                clearInterval(checkVKSDK);
                handleVKAuth();
            }
        });

        vkScript.addEventListener('error', () => {
            debugLog('Ошибка загрузки скрипта VK');
            clearInterval(checkVKSDK);
            showError('Не удалось загрузить VK SDK. Пожалуйста, проверьте подключение к интернету.');
        });
    }
});
</script>

<style>
.spinner-border {
    width: 3rem;
    height: 3rem;
}
#debug-info {
    max-height: 200px;
    overflow-y: auto;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    font-family: monospace;
}
</style>
{% endblock %}