{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <h3 class="mt-3">Выполняется вход через VK...</h3>
            <p class="text-muted" id="status-text">Инициализация...</p>
            <div id="debug-info" class="text-start small text-muted mt-3" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
// Debug function to log messages
function debugLog(message) {
    console.log('[DEBUG]', message);
    const debugEl = document.getElementById('debug-info');
    if (debugEl) {
        debugEl.style.display = 'block';
        debugEl.innerHTML += `<div>${new Date().toISOString()}: ${message}</div>`;
    }
}

// Function to update status message
function updateStatus(message, isError = false) {
    debugLog(`Status update: ${message}`);
    const statusText = document.getElementById('status-text');
    if (statusText) {
        statusText.textContent = message;
        if (isError) {
            statusText.classList.add('text-danger');
        }
    }
}

// Function to show error message
function showError(message) {
    debugLog(`Error: ${message}`);
    updateStatus(message, true);
    const container = document.querySelector('.container');
    if (container) {
        const retryBtn = document.createElement('button');
        retryBtn.className = 'btn btn-primary mt-3';
        retryBtn.textContent = 'Повторить';
        retryBtn.onclick = () => window.location.reload();
        container.appendChild(retryBtn);
    }
}

// Main authentication function
async function handleVKAuth() {
    try {
        updateStatus('Получение кода авторизации...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (!code) {
            throw new Error('Отсутствует код авторизации VK');
        }

        updateStatus('Обмен кода авторизации...');
        
        // Exchange code for access token by sending to our backend
        const response = await fetch("{{ request.path }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                code: code,
                redirect_uri: window.location.origin + "{{ request.path }}"
            })
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || 'Ошибка сервера при обмене кода');
        }

        const result = await response.json();
        debugLog('Auth result:', result);
        
        if (result.access_token) {
            // Use the access token to authenticate the user
            // ...
            window.location.href = result.redirect;
        } else {
            window.location.href = "/";
        }

    } catch (error) {
        console.error('VK Auth Error:', error);
        showError(error.message || 'Произошла ошибка при авторизации');
    }
}

// Start the authentication process when the page loads
document.addEventListener('DOMContentLoaded', () => {
    // Start authentication immediately without waiting for VK SDK
    debugLog('Страница загружена, начинаем аутентификацию');
    handleVKAuth();
});
</script>

<style>
.spinner-border {
    width: 3rem;
    height: 3rem;
}
#debug-info {
    max-height: 200px;
    overflow-y: auto;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    font-family: monospace;
}
</style>
{% endblock %}