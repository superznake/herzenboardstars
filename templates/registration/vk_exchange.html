{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <h3 class="mt-3">Выполняется вход через VK...</h3>
            <p class="text-muted" id="status-text">Инициализация VK ID...</p>
        </div>
    </div>
</div>

<!-- Load VK ID SDK with error handling -->
<script src="https://unpkg.com/@vkid/sdk@2.2.0/dist-sdk/umd/index.js" id="vkid-script"></script>

<script>
// Configuration
const VK_APP_ID = {{ VK_APP_ID|default:54356598 }};
const VK_REDIRECT_URI = window.location.origin + "{{ request.path }}";

// Function to update status message
function updateStatus(message, isError = false) {
    const statusText = document.getElementById('status-text');
    if (statusText) {
        statusText.textContent = message;
        if (isError) {
            statusText.classList.add('text-danger');
        }
    }
}

// Function to show error message
function showError(message) {
    updateStatus(message, true);
    const container = document.querySelector('.container');
    if (container) {
        const retryBtn = document.createElement('button');
        retryBtn.className = 'btn btn-primary mt-3';
        retryBtn.textContent = 'Повторить';
        retryBtn.onclick = () => window.location.reload();
        container.appendChild(retryBtn);
    }
}

// Function to initialize VK ID
function initVKID() {
    if (typeof VKID === 'undefined') {
        throw new Error('VK ID SDK не загружен');
    }

    try {
        VKID.Config.set({
            app: VK_APP_ID,
            redirectUrl: VK_REDIRECT_URI,
            scopes: ["openid", "email"]
        });
        return true;
    } catch (e) {
        console.error('VK ID initialization error:', e);
        throw new Error('Ошибка инициализации VK ID');
    }
}

// Main authentication function
async function handleVKAuth() {
    try {
        updateStatus('Инициализация VK ID SDK...');
        
        // Initialize VK ID
        if (!initVKID()) {
            throw new Error('Не удалось инициализировать VK ID');
        }

        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');

        if (!code) {
            throw new Error('Отсутствует код авторизации VK');
        }

        updateStatus('Обмен кода авторизации...');
        const exchangeResult = await VKID.Auth.exchangeCode(code, state);
        
        if (!exchangeResult?.access_token) {
            throw new Error('Не удалось получить токен доступа');
        }

        updateStatus('Получение данных пользователя...');
        const userInfo = await fetch("https://id.vk.com/oauth2/user_info", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${exchangeResult.access_token}`
            }
        }).then(r => r.json());

        if (!userInfo?.sub) {
            console.error("VK userinfo response:", userInfo);
            throw new Error('Не удалось получить данные пользователя');
        }

        updateStatus('Вход в систему...');
        const response = await fetch("{{ request.path }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                vk_id: userInfo.sub,
                first_name: userInfo.given_name || "",
                last_name: userInfo.family_name || "",
                email: userInfo.email || "",
                access_token: exchangeResult.access_token
            })
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || 'Ошибка сервера');
        }

        const result = await response.json();
        window.location.href = result.redirect || "/";

    } catch (error) {
        console.error('VK Auth Error:', error);
        showError(error.message || 'Произошла ошибка при авторизации');
    }
}

// Wait for SDK to load
function checkSDKLoaded() {
    if (window.VKID) {
        handleVKAuth();
    } else {
        setTimeout(checkSDKLoaded, 100);
    }
}

// Start the process when the page loads
document.addEventListener('DOMContentLoaded', () => {
    // Start checking for SDK
    setTimeout(() => {
        if (!window.VKID) {
            showError('Не удалось загрузить VK ID SDK. Пожалуйста, проверьте подключение к интернету и обновите страницу.');
            return;
        }
    }, 5000); // Give up after 5 seconds
    
    // Start checking for SDK
    checkSDKLoaded();
});

// Also try to handle script load event
document.getElementById('vkid-script').addEventListener('load', () => {
    if (window.VKID) {
        handleVKAuth();
    }
});

document.getElementById('vkid-script').addEventListener('error', () => {
    showError('Не удалось загрузить VK ID SDK. Пожалуйста, проверьте подключение к интернету и обновите страницу.');
});
</script>

<style>
.spinner-border {
    width: 3rem;
    height: 3rem;
}
</style>
{% endblock %}